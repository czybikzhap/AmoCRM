# Интеграция с amoCRM 

## Описание проекта

Данный проект содержит PHP-скрипт для работы с API amoCRM v4, который выполняет две основные функции:

1. **Перемещение сделок с высоким бюджетом** - автоматически перемещает сделки с бюджетом > 5000 с этапа "Заявка" на этап "Ожидание клиента"
2. **Копирование подтвержденных сделок** - создает копии сделок с бюджетом = 4999 с этапа "Клиент подтвердил" на этап "Ожидание клиента", включая все примечания и задачи

## Структура проекта

```
testwork/
├── src/
│   └── AmoCrmV4Client.php    # Класс работы с amoCRM API 
├── index.php                 # Единый скрипт с реализацией ТЗ и выбором метода
├── README.md                 # Инструкции
└── TOKEN.txt                 # Создается автоматически после авторизации
```

## Установка и настройка

### 1. Создание интеграции в amoCRM

1. Войдите в ваш аккаунт amoCRM
2. Перейдите в раздел "Настройки" → "Интеграции"
3. Создайте новую интеграцию
4. Скопируйте полученные данные:
   - `client_id`
   - `client_secret`
   - `code`
   - `redirect_uri`

### 2. Настройка скрипта

Откройте файл `index.php` и обновите следующие константы:

```php
define('SUB_DOMAIN', 'ваш_поддомен');           // Ваш поддомен amoCRM
define('CLIENT_ID', 'ваш_client_id');           // ID клиента из интеграции
define('CLIENT_SECRET', 'ваш_client_secret');   // Секретный ключ из интеграции
define('CODE', 'ваш_code');                     // Код авторизации из интеграции
define('REDIRECT_URL', 'https://ваш_поддомен.amocrm.ru'); // URL редиректа
```

### 3. Получение ID воронок и этапов

1. Запустите скрипт: `php index.php`
2. Скрипт выведет список всех воронок и этапов в вашем аккаунте
3. Найдите нужные ID:
   - ID воронки "Воронка"
   - ID этапа "Заявка"
   - ID этапа "Клиент подтвердил"
   - ID этапа "Ожидание клиента"

### 4. Обновление ID в коде

В файле `index.php` обновите значения констант в блоке ID:

```php
$pipelineId = 123456;           // ID воронки "Воронка"
$applicationStatusId = 789;     // ID этапа "Заявка"
$confirmedStatusId = 101112;    // ID этапа "Клиент подтвердил"
$waitingStatusId = 131415;      // ID этапа "Ожидание клиента"
```

### 5. Активация функций

Скрипт уже содержит вызовы функций и выбор режима через аргумент командной строки.

## Использование

### Запуск скрипта и режимы

```bash
# Тест подключения и вывод воронок/этапов
php index.php test

# Только функция 1: перемещение сделок (>5000) из "Заявка" в "Ожидание клиента"
php index.php 1

# Только функция 2: копирование сделок (=4999) из "Клиент подтвердил" в "Ожидание клиента"
php index.php 2

# Запуск обеих функций подряд (режим по умолчанию)
php index.php all
```

### Функция 1: moveHighBudgetLeads()

**Назначение:** Перемещает сделки с бюджетом > 5000 с этапа "Заявка" на этап "Ожидание клиента"

**Алгоритм работы:**
1. Получает все сделки на этапе "Заявка" в воронке "Воронка"
2. Проверяет бюджет каждой сделки
3. Если бюджет > 5000, перемещает сделку на этап "Ожидание клиента"
4. Выводит отчет о количестве перемещенных сделок

### Функция 2: copyConfirmedLeads()

**Назначение:** Копирует сделки с бюджетом = 4999 с этапа "Клиент подтвердил" на этап "Ожидание клиента"

**Алгоритм работы:**
1. Получает все сделки на этапе "Клиент подтвердил" с бюджетом 4999
2. Для каждой найденной сделки:
   - Создает копию с названием "оригинальное_название (копия)"
   - Копирует все поля сделки
   - Создает новую сделку на этапе "Ожидание клиента"
   - Копирует все примечания из оригинальной сделки (POST /api/v4/leads/{lead_id}/notes)
   - Копирует все задачи из оригинальной сделки (GET/POST /api/v4/tasks)
3. Выводит отчет о количестве скопированных сделок

## Дополнительные функции

### copyLeadNotes()
Копирует все примечания из исходной сделки в целевую сделку (используется эндпоинт примечаний сделок v4).

### copyLeadTasks()
Копирует все задачи из исходной сделки в целевую сделку. Получение — `GET /api/v4/tasks?filter[entity_id]=...&filter[entity_type]=leads`,
создание — `POST /api/v4/tasks` (массив задач).

## Обработка ошибок

- Все ошибки записываются в файл `ERROR_LOG.txt`
- Скрипт продолжает работу даже при ошибках в отдельных операциях
- Подробная информация об ошибках выводится в консоль

## Требования

- PHP 7.0 или выше
- Расширение cURL
- Доступ к интернету
- Валидная интеграция с amoCRM

## Безопасность

- Токены доступа автоматически обновляются при истечении срока действия
- Секретные ключи хранятся в константах (в продакшене рекомендуется использовать переменные окружения)
- Все API запросы выполняются через HTTPS

## Логирование

- Успешные операции логируются в консоль
- Ошибки записываются в файл `ERROR_LOG.txt`
- Токены сохраняются в файле `TOKEN.txt`


## Поддержка

При возникновении проблем проверьте:
1. Правильность настроек интеграции
2. Корректность ID воронок и этапов
3. Наличие прав доступа к API
4. Содержимое файла `ERROR_LOG.txt`

